---
import { siteConfig } from "@config/site.config";
import Button from "@components/ui/Button.astro";
import { Icon } from "@components/ui/Icon";

import { services } from "@data/services";
import { locations } from "@data/locations";
import { isService, isLocation } from "@utils/typeguards";

const navLinks = [
    {
        name: "Services",
        href: "/services",
        icon: "heroicons:wrench-screwdriver",
    },
    {
        name: "Service Areas",
        href: "/service-areas",
        icon: "heroicons:map-pin",
    },
    { name: "FAQ", href: "/faq", icon: "heroicons:question-mark-circle" },
    { name: "Reviews", href: "/reviews", icon: "heroicons:star-solid" },
    { name: "About", href: "/about", icon: "heroicons:information-circle" },
    { name: "Contact", href: "/contact", icon: "heroicons:envelope" },
];
---

<header
    id="site-header"
    class="fixed top-0 left-0 right-0 z-50 bg-cream-100/90 backdrop-blur-sm shadow-md transition-all duration-300"
>
    <div class="container mx-auto px-3 sm:px-4 lg:px-6">
        <div class="flex items-center justify-between h-16 sm:h-20">
            <!-- Logo -->
            <a href="/" class="flex items-center flex-shrink-0">
                <img
                    src="/images/logos/ez2fix-logo.png"
                    alt="Ez2Fix LLC - Licensed Garage Door Repair Northern NJ"
                    class="h-10 w-auto sm:h-12 lg:h-14"
                    width="171"
                    height="48"
                    loading="eager"
                    fetchpriority="high"
                    decoding="async"
                />
            </a>

            <!-- Desktop Navigation -->
            <nav class="hidden lg:flex items-center space-x-6">
                {
                    navLinks.map((link) => {
                        if (link.name === "Services") {
                            return (
                                <div class="relative group">
                                    <a
                                        href={link.href}
                                        class="flex items-center text-dark-700 hover:text-gold-600 font-semibold transition-colors focus:outline-none py-6"
                                    >
                                        {link.name}
                                        <Icon
                                            name="chevronDown"
                                            className="w-4 h-4 ml-1 transition-transform group-hover:rotate-180"
                                        />
                                    </a>
                                    <div class="hidden absolute left-0 top-full w-[800px] bg-white shadow-xl rounded-xl border border-gold-200/20 group-hover:block p-6 z-50">
                                        <div class="grid grid-cols-3 gap-4">
                                            {services
                                                .slice(0, 9)
                                                .map((service) => (
                                                    <a
                                                        href={`/services/${service.slug}`}
                                                        class="flex items-start p-3 rounded-lg hover:bg-gold-50 transition-colors group/item"
                                                    >
                                                        <Icon
                                                            name={
                                                                service.icon ||
                                                                "wrench"
                                                            }
                                                            className="w-5 h-5 text-gold-600 mt-0.5 flex-shrink-0"
                                                        />
                                                        <div class="ml-3">
                                                            <p class="text-sm font-bold text-dark-900 group-hover/item:text-gold-700">
                                                                {service.title}
                                                            </p>
                                                        </div>
                                                    </a>
                                                ))}
                                        </div>
                                        <div class="mt-6 pt-4 border-t border-gray-200">
                                            <a
                                                href="/services"
                                                class="flex items-center justify-center px-6 py-3 bg-gold-500 text-dark-900 rounded-lg font-bold hover:bg-gold-600 hover:text-white transition-all shadow-md hover:shadow-lg group/link"
                                            >
                                                View All Services
                                                <Icon
                                                    name="arrowRight"
                                                    className="w-5 h-5 ml-2 transition-transform group-hover/link:translate-x-1"
                                                />
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            );
                        } else if (link.name === "Service Areas") {
                            return (
                                <div class="relative group">
                                    <a
                                        href={link.href}
                                        class="flex items-center text-dark-700 hover:text-gold-600 font-semibold transition-colors focus:outline-none py-6"
                                    >
                                        {link.name}
                                        <Icon
                                            name="chevronDown"
                                            className="w-4 h-4 ml-1 transition-transform group-hover:rotate-180"
                                        />
                                    </a>
                                    <div class="hidden absolute left-0 top-full w-[700px] bg-white shadow-xl rounded-xl border border-gold-200/20 group-hover:block p-6 z-50">
                                        <div class="grid grid-cols-4 gap-4">
                                            {locations.map((location) => (
                                                <a
                                                    href={`/service-areas/${location.slug}`}
                                                    class="flex items-center p-2 rounded-lg hover:bg-gold-50 transition-colors group/item"
                                                >
                                                    <Icon
                                                        name="mapPin"
                                                        className="w-4 h-4 text-gold-500 mr-2 group-hover/item:text-gold-600"
                                                    />
                                                    <span class="text-sm font-medium text-dark-700 group-hover/item:text-gold-700">
                                                        {location.city}
                                                    </span>
                                                </a>
                                            ))}
                                        </div>
                                        <div class="mt-6 pt-4 border-t border-gray-200">
                                            <a
                                                href="/service-areas"
                                                class="flex items-center justify-center px-6 py-3 bg-gold-500 text-dark-900 rounded-lg font-bold hover:bg-gold-600 hover:text-white transition-all shadow-md hover:shadow-lg group/link"
                                            >
                                                View All Service Areas
                                                <Icon
                                                    name="arrowRight"
                                                    className="w-5 h-5 ml-2 transition-transform group-hover/link:translate-x-1"
                                                />
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            );
                        } else {
                            return (
                                <a
                                    href={link.href}
                                    class="text-dark-700 hover:text-gold-600 font-semibold transition-colors"
                                >
                                    {link.name}
                                </a>
                            );
                        }
                    })
                }
            </nav>

            <!-- Desktop CTAs -->
            <div class="hidden lg:flex items-center space-x-4">
                <Button
                    variant="secondary"
                    size="md"
                    href={`tel:${siteConfig.contact.phoneRaw}`}
                >
                    <Icon name="phone" className="w-5 h-5 mr-2" />
                    {siteConfig.contact.phone}
                </Button>
                <Button
                    variant="primary"
                    size="md"
                    href="/booking?utm_source=website&utm_medium=cta&utm_campaign=header"
                >
                    <Icon name="clipboard" className="w-5 h-5 mr-2" />
                    Book Online
                </Button>
            </div>

            <!-- Mobile Right Section (CTAs + Menu) -->
            <div
                class="flex lg:hidden items-center space-x-1.5 sm:space-x-3 ml-auto"
            >
                <a
                    href={`tel:${siteConfig.contact.phoneRaw}`}
                    class="flex items-center justify-center px-2 py-1.5 sm:p-2 text-dark-900 border-2 border-dark-900 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-all font-bold text-xs whitespace-nowrap"
                    aria-label="Call Now"
                >
                    <Icon name="phone" className="w-4 h-4" />
                    <span class="ml-1 hidden xs:inline">Call</span>
                </a>
                <a
                    href="/booking?utm_source=website&utm_medium=cta&utm_campaign=header"
                    class="flex items-center justify-center px-2 py-1.5 sm:px-3 sm:py-2 bg-gold-500 text-dark-900 rounded-lg font-bold text-xs hover:bg-gold-600 active:bg-gold-700 hover:text-white transition-all whitespace-nowrap"
                    aria-label="Book Online"
                >
                    <Icon name="clipboard" className="w-4 h-4" />
                    <span class="ml-1">Book</span>
                </a>

                <!-- Mobile Menu Button -->
                <button
                    id="mobile-menu-button"
                    class="p-1.5 sm:p-2 text-dark-700 hover:text-gold-600"
                    aria-label="Toggle menu"
                    aria-expanded="false"
                >
                    <Icon
                        name="menu"
                        className="w-6 h-6 sm:w-7 sm:h-7"
                        id="mobile-menu-icon-open"
                    />
                    <Icon
                        name="close"
                        className="w-7 h-7 sm:w-8 sm:h-8 hidden"
                        id="mobile-menu-icon-close"
                    />
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Panel -->
    <div
        id="mobile-menu"
        class="hidden lg:hidden absolute top-full left-0 w-full h-[calc(100vh-80px)] bg-white border-t border-gray-200 overflow-y-auto"
    >
        <nav class="container mx-auto px-4 sm:px-6 py-4 flex flex-col">
            {
                navLinks.map((link) => {
                    if (
                        link.name === "Services" ||
                        link.name === "Service Areas"
                    ) {
                        const items =
                            link.name === "Services"
                                ? services.slice(0, 9)
                                : locations;

                        return (
                            <div class="border-b border-gray-200">
                                <button class="mobile-dropdown-trigger w-full flex items-center justify-between text-dark-700 hover:text-gold-600 font-semibold transition-colors py-3 text-lg">
                                    <span class="flex items-center">
                                        {link.name}
                                    </span>
                                    <Icon
                                        name="chevronDown"
                                        className="chevron-icon w-5 h-5 transition-transform duration-300"
                                    />
                                </button>
                                <div class="mobile-dropdown-content hidden mt-2 ml-4 pl-5 border-l-2 border-gold-100 space-y-2 pb-2">
                                    {items.map((item) => {
                                        if (isService(item)) {
                                            return (
                                                <a
                                                    href={`/services/${item.slug}`}
                                                    class="flex items-center text-dark-600 hover:text-gold-600 py-1.5 transition-colors"
                                                >
                                                    {item.title}
                                                </a>
                                            );
                                        }
                                        if (isLocation(item)) {
                                            return (
                                                <a
                                                    href={`/service-areas/${item.slug}`}
                                                    class="flex items-center text-dark-600 hover:text-gold-600 py-1.5 transition-colors"
                                                >
                                                    <Icon
                                                        name="mapPin"
                                                        className="w-4 h-4 mr-2 text-gold-400 flex-shrink-0"
                                                    />
                                                    {item.city}
                                                </a>
                                            );
                                        }
                                        return null;
                                    })}{" "}
                                    <a
                                        href={link.href}
                                        class="block mt-2 pt-2 border-t border-gray-100 font-bold text-gold-600 hover:text-gold-700 flex items-center"
                                    >
                                        <Icon
                                            name="arrowRight"
                                            className="w-5 h-5 mr-1.5"
                                        />
                                        View All {link.name}
                                    </a>
                                </div>
                            </div>
                        );
                    } else {
                        return (
                            <a
                                href={link.href}
                                class="flex items-center text-dark-700 hover:text-gold-600 font-semibold transition-colors py-3 text-lg border-b border-gray-200"
                            >
                                {link.name}
                            </a>
                        );
                    }
                })
            }
            <div
                class="pt-6 mt-4 border-t border-gray-200 flex flex-col space-y-3"
            >
                <Button
                    variant="primary"
                    size="lg"
                    href="/booking?utm_source=website&utm_medium=cta&utm_campaign=header-mobile"
                >
                    <Icon name="clipboard" className="w-5 h-5 mr-2" />
                    Book Online
                </Button>
            </div>
        </nav>
    </div>
</header>

<script>
    const header = document.getElementById("site-header");
    let ticking = false;

    // Scroll transparency effect
    window.addEventListener("scroll", () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                if (window.scrollY > 50) {
                    header?.classList.remove("bg-cream-100/90");
                    header?.classList.add("bg-cream-100/70");
                } else {
                    header?.classList.remove("bg-cream-100/70");
                    header?.classList.add("bg-cream-100/90");
                }
                ticking = false;
            });
            ticking = true;
        }
    });

    // Mobile menu functionality
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const openIcon = document.getElementById("mobile-menu-icon-open");
    const closeIcon = document.getElementById("mobile-menu-icon-close");
    const body = document.body;

    menuButton?.addEventListener("click", () => {
        const isExpanded = menuButton.getAttribute("aria-expanded") === "true";
        mobileMenu?.classList.toggle("hidden");
        openIcon?.classList.toggle("hidden");
        closeIcon?.classList.toggle("hidden");
        menuButton.setAttribute("aria-expanded", String(!isExpanded));

        if (!isExpanded) {
            body.style.overflow = "hidden";
        } else {
            body.style.overflow = "";
        }
    });

    // Mobile dropdown functionality
    document.querySelectorAll(".mobile-dropdown-trigger").forEach((trigger) => {
        trigger.addEventListener("click", () => {
            const content = trigger.nextElementSibling;
            const chevron = trigger.querySelector(".chevron-icon");

            if (content?.classList.contains("hidden")) {
                content.classList.remove("hidden");
                chevron?.classList.add("rotate-180");
            } else {
                content?.classList.add("hidden");
                chevron?.classList.remove("rotate-180");
            }
        });
    });
</script>
