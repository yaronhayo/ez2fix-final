---
import { getCollection } from "astro:content";

import ResponsiveImage from "@components/ui/ResponsiveImage.astro";
import Button from "@components/ui/Button.astro";
import { Icon } from "@components/ui/Icon";

// Fetch and sort blog posts
const allPosts = await getCollection("blog");
const recentPosts = allPosts
    .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
    .slice(0, 8);

// Helper to format date
const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};
---

<section class="py-16 bg-white border-t border-gray-100">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-dark-700 mb-4">
                Expert Garage Door Tips
            </h2>
            <p class="text-lg text-dark-600 max-w-2xl mx-auto">
                Helpful guides and maintenance tips from our licensed
                technicians.
            </p>
        </div>

        <!-- Carousel Container -->
        <div class="relative" role="region" aria-labelledby="carousel-heading">
            <h3 id="carousel-heading" class="sr-only">Recent blog posts</h3>
            <!-- Scroll Container -->
            <div
                class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-8 -mx-4 px-4 scrollbar-hide"
                id="tips-carousel"
            >
                {
                    recentPosts.map((post) => (
                        <div class="carousel-item snap-center flex-shrink-0">
                            <a
                                href={`/blog/${post.slug}`}
                                class="group h-full block"
                            >
                                <div class="bg-gray-50 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow h-full border border-gray-100 flex flex-col">
                                    <div class="h-48 overflow-hidden relative">
                                        <ResponsiveImage
                                            src={
                                                post.data.image ||
                                                "/images/blog/repair-placeholder.webp"
                                            }
                                            alt={post.data.title}
                                            width={400}
                                            height={200}
                                            class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300"
                                        />
                                        <div class="absolute top-3 left-3 bg-gold-500 text-dark-900 text-xs font-bold px-2 py-1 rounded">
                                            {post.data.category}
                                        </div>
                                    </div>
                                    <div class="p-5 flex flex-col flex-grow">
                                        <div class="text-xs text-gray-500 mb-2 flex items-center">
                                            <Icon
                                                name="calendar"
                                                className="w-3 h-3 mr-1"
                                            />
                                            {formatDate(post.data.publishDate)}
                                        </div>
                                        <h3 class="text-lg font-bold text-dark-800 mb-2 group-hover:text-gold-600 transition-colors line-clamp-2">
                                            {post.data.title}
                                        </h3>
                                        <p class="text-dark-600 text-sm mb-4 line-clamp-3 flex-grow">
                                            {post.data.description}
                                        </p>
                                        <span class="text-gold-600 font-semibold text-sm flex items-center mt-auto">
                                            Read Guide{" "}
                                            <Icon
                                                name="arrowRight"
                                                className="w-4 h-4 ml-1"
                                            />
                                        </span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    ))
                }
            </div>

            <!-- Navigation Buttons -->
            <button
                class="absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg text-dark-700 hover:text-gold-600 disabled:opacity-0 disabled:cursor-not-allowed z-10 border border-gray-100 transition-opacity"
                id="carousel-prev"
                aria-label="Previous posts"
            >
                <Icon name="chevronLeft" className="w-6 h-6" />
            </button>
            <button
                class="absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg text-dark-700 hover:text-gold-600 disabled:opacity-0 disabled:cursor-not-allowed z-10 border border-gray-100 transition-opacity"
                id="carousel-next"
                aria-label="Next posts"
            >
                <Icon name="chevronRight" className="w-6 h-6" />
            </button>
        </div>

        <!-- CTA -->
        <div class="text-center mt-10">
            <Button variant="secondary" href="/blog">
                <Icon name="bookOpen" className="w-5 h-5 mr-2" />
                Read All Guides & Tips
            </Button>
        </div>
    </div>
</section>

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .carousel-item {
        width: 85%;
        flex: 0 0 85%;
    }

    @media (min-width: 640px) {
        /* sm breakpoint */
        .carousel-item {
            width: calc(50% - 12px);
            flex: 0 0 calc(50% - 12px);
        }
    }

    @media (min-width: 1024px) {
        /* lg breakpoint */
        .carousel-item {
            width: calc(33.333% - 16px);
            flex: 0 0 calc(33.333% - 16px);
        }
    }

    @media (min-width: 1280px) {
        /* xl breakpoint */
        .carousel-item {
            width: calc(25% - 18px);
            flex: 0 0 calc(25% - 18px);
        }
    }
</style>

<script>
    const carousel = document.getElementById("tips-carousel");
    const prevBtn = document.getElementById(
        "carousel-prev",
    ) as HTMLButtonElement | null;
    const nextBtn = document.getElementById(
        "carousel-next",
    ) as HTMLButtonElement | null;

    if (carousel && prevBtn && nextBtn) {
        const scrollAmount = () => {
            const item = carousel.querySelector(
                ".carousel-item",
            ) as HTMLElement | null;
            return item ? item.offsetWidth + 24 : 300; // 24 is the gap (1.5rem)
        };

        const updateButtonState = () => {
            if (!carousel) return;
            const scrollLeft = carousel.scrollLeft;
            const scrollWidth = carousel.scrollWidth;
            const clientWidth = carousel.clientWidth;

            // A small tolerance to handle floating point inaccuracies
            const tolerance = 2;

            if (prevBtn) {
                prevBtn.disabled = scrollLeft < tolerance;
            }
            if (nextBtn) {
                nextBtn.disabled =
                    scrollLeft + clientWidth >= scrollWidth - tolerance;
            }
        };

        prevBtn.addEventListener("click", () => {
            carousel.scrollBy({ left: -scrollAmount(), behavior: "smooth" });
        });

        nextBtn.addEventListener("click", () => {
            carousel.scrollBy({ left: scrollAmount(), behavior: "smooth" });
        });

        // Use ResizeObserver to update on size changes, and scroll for manual scroll
        const observer = new ResizeObserver(updateButtonState);
        observer.observe(carousel);
        carousel.addEventListener("scroll", updateButtonState, {
            passive: true,
        });

        // Initial check
        updateButtonState();
    }
</script>
