---
import { locations as allLocations } from "@data/locations";
import type { Location } from "@data/locations";

interface Props {
    locations?: Location[];
    zoom?: number;
    center?: { lat: number; lng: number };
}

const {
    locations = allLocations,
    zoom = 10,
    center = { lat: 40.7357, lng: -74.1724 }, // Default to Newark
} = Astro.props;

const apiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;
const mapId = `google_map_${Math.random().toString(36).substring(2, 11)}`;

// Prepare locations data for client-side
const mapLocations = locations.map((loc) => ({
    title: loc.city,
    position: loc.coordinates,
    url: `/service-areas/${loc.slug}`,
}));
---

<div
    id={mapId}
    style={`width: 100%; background-color: #f0f0f0;`}
    class="rounded-xl shadow-lg border border-gray-200 relative group h-[400px] lg:h-[500px]"
>
    <div
        id={`${mapId}-loading`}
        class="absolute inset-0 flex items-center justify-center bg-gray-100 z-10"
    >
        <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-gold-500"
        >
        </div>
    </div>
    <div
        id={`${mapId}-error`}
        class="hidden absolute inset-0 flex items-center justify-center bg-gray-100 text-red-500 p-4 text-center z-20"
    >
    </div>
</div>

<script is:inline define:vars={{ mapId, apiKey, mapLocations, zoom, center }}>
    // @ts-nocheck

    // Load Google Maps API if not already loaded
    function loadGoogleMaps() {
        if (window.google && window.google.maps) {
            initMap();
            return;
        }

        if (document.getElementById("google-maps-script")) {
            // Script already loading, wait for it
            const checkGoogle = setInterval(() => {
                if (window.google && window.google.maps) {
                    clearInterval(checkGoogle);

                    initMap();
                }
            }, 100);
            return;
        }

        const script = document.createElement("script");
        script.id = "google-maps-script";
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap_${mapId}`;
        script.async = true;
        script.defer = true;

        script.onerror = (e) => {
            console.error("[GoogleMap] Failed to load Google Maps script", e);
            showError(
                "Failed to load Google Maps API. Please check your network connection.",
            );
        };

        // Create a global callback for this specific map instance
        window[`initMap_${mapId}`] = () => {
            initMap();
        };

        document.head.appendChild(script);
    }

    function showError(message) {
        const loadingEl = document.getElementById(`${mapId}-loading`);
        const errorEl = document.getElementById(`${mapId}-error`);
        if (loadingEl) loadingEl.style.display = "none";
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.remove("hidden");
        }
    }

    function initMap() {
        const mapElement = document.getElementById(mapId);
        const loadingEl = document.getElementById(`${mapId}-loading`);

        if (!mapElement) {
            console.error(`[GoogleMap] Map element ${mapId} not found`);
            return;
        }

        try {
            const mapOptions = {
                zoom: zoom,
                center: center,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }],
                    },
                ],
            };

            const map = new google.maps.Map(mapElement, mapOptions);

            const bounds = new google.maps.LatLngBounds();
            const infoWindow = new google.maps.InfoWindow();

            // Custom SVG marker for better visibility on satellite map
            // Gold fill with white stroke for high contrast
            const icon = {
                path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
                fillColor: "#D4AF37", // Brand Gold
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#FFFFFF", // White stroke for contrast
                scale: 2,
                anchor: new google.maps.Point(12, 22),
                labelOrigin: new google.maps.Point(12, -10),
            };

            let markersCreated = 0;
            mapLocations.forEach((location) => {
                if (!location.position) return;

                const marker = new google.maps.Marker({
                    position: location.position,
                    map: map,
                    title: location.title,
                    icon: icon,
                    animation: google.maps.Animation.DROP,
                });

                // Extend bounds to include this marker
                bounds.extend(location.position);

                // Add click listener
                marker.addListener("click", () => {
                    const content = `
                        <div style="padding: 8px; text-align: center;">
                            <h3 style="font-weight: bold; margin-bottom: 4px; color: #1a1a1a;">${location.title}</h3>
                            <a href="${location.url}" style="color: #d4af37; text-decoration: none; font-weight: bold;">View Service Area</a>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
                markersCreated++;
            });

            // Fit bounds if there are multiple locations
            if (mapLocations.length > 1) {
                map.fitBounds(bounds);
                // Add a little padding
                const listener = google.maps.event.addListener(
                    map,
                    "idle",
                    () => {
                        if (map.getZoom() > 14) map.setZoom(14);
                        google.maps.event.removeListener(listener);
                    },
                );
            } else if (mapLocations.length === 1) {
                map.setCenter(mapLocations[0].position);
                map.setZoom(13);
            }

            // Hide loading spinner
            if (loadingEl) loadingEl.style.display = "none";
        } catch (error) {
            console.error("[GoogleMap] Error initializing map:", error);
            showError("An error occurred while initializing the map.");
        }
    }

    // Start loading with IntersectionObserver
    if (apiKey) {
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        loadGoogleMaps();
                        observer.disconnect();
                    }
                });
            },
            {
                rootMargin: "200px", // Load when map is 200px away from viewport
            },
        );

        const mapElement = document.getElementById(mapId);
        if (mapElement) {
            observer.observe(mapElement);
        }
    } else {
        console.error("[GoogleMap] Google Maps API Key is missing");
        showError("Map configuration missing (API Key)");
    }
</script>
