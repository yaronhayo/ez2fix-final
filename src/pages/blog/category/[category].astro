---
export const prerender = true;
import BaseLayout from "@layouts/BaseLayout.astro";
import Header from "@components/layout/Header.astro";
import Footer from "@components/layout/Footer.astro";
import FinalCTA from "@components/sections/FinalCTA.astro";
import { categories } from "../../../data/categories";
import { getCollection } from "astro:content";
import ResponsiveImage from "@components/ui/ResponsiveImage.astro";
import { Icon } from "@components/ui/Icon";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const uniqueCategories = [
        ...new Set(allPosts.map((post) => post.data.category)),
    ];

    return uniqueCategories.map((category) => {
        const filteredPosts = allPosts.filter(
            (post) => post.data.category === category,
        );
        return {
            params: { category },
            props: { posts: filteredPosts },
        };
    });
}

const { category } = Astro.params;
const { posts } = Astro.props;

// Sort posts by date
const sortedPosts = posts.sort(
    (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

const categoryData = categories[category as string] || {
    id: category,
    title: category,
    description: `Articles about ${category}`,
    image: "/images/hero-bg.jpg", // Fallback
};

const metaTitle = `${categoryData.title} - Garage Door Blog | Ez2Fix`;
const metaDescription = categoryData.description;
---

<BaseLayout title={metaTitle} description={metaDescription}>
    <Header />

    {/* Hero Section */}
    <section
        class="relative bg-dark-900 text-white py-20 lg:py-28 overflow-hidden"
    >
        <div class="absolute inset-0 z-0">
            <div class="absolute inset-0 bg-dark-900/80 z-10"></div>
            <ResponsiveImage
                src={categoryData.image}
                alt={categoryData.title}
                width={1920}
                height={1080}
                loading="eager"
                fetchpriority="high"
                class="w-full h-full object-cover"
            />
        </div>

        <div class="container mx-auto px-4 relative z-10 text-center">
            <div
                class="inline-block bg-gold-500 text-dark-900 px-4 py-1 rounded-full text-sm font-bold mb-4 uppercase tracking-wide"
            >
                Blog Category
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-6 text-cream-100">
                {categoryData.title}
            </h1>
            <p class="text-xl text-cream-200 max-w-2xl mx-auto">
                {categoryData.description}
            </p>
        </div>
    </section>

    {/* Posts Grid */}
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                {
                    sortedPosts.map((post) => (
                        <article class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow flex flex-col h-full">
                            <a
                                href={`/blog/${post.slug}`}
                                class="block aspect-video overflow-hidden bg-gray-100"
                            >
                                {post.data.image ? (
                                    <ResponsiveImage
                                        src={post.data.image}
                                        alt={post.data.title}
                                        width={400}
                                        height={200}
                                        loading="lazy"
                                        class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                                    />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-100">
                                        <Icon
                                            name="image"
                                            className="w-12 h-12"
                                        />
                                    </div>
                                )}
                            </a>
                            <div class="p-6 flex-1 flex flex-col">
                                <div class="flex items-center text-sm text-gray-500 mb-3">
                                    <span class="bg-cream-100 text-gold-700 px-2 py-1 rounded text-xs font-semibold uppercase tracking-wide">
                                        {categories[post.data.category]
                                            ?.title || post.data.category}
                                    </span>
                                    <span class="mx-2">â€¢</span>
                                    <time
                                        datetime={post.data.publishDate.toISOString()}
                                    >
                                        {post.data.publishDate.toLocaleDateString(
                                            "en-US",
                                            {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                            },
                                        )}
                                    </time>
                                </div>
                                <h2 class="text-xl font-bold text-dark-800 mb-3 line-clamp-2 hover:text-gold-600 transition-colors">
                                    <a href={`/blog/${post.slug}`}>
                                        {post.data.title}
                                    </a>
                                </h2>
                                <p class="text-dark-600 mb-4 line-clamp-3 flex-1">
                                    {post.data.description}
                                </p>
                                <a
                                    href={`/blog/${post.slug}`}
                                    class="inline-flex items-center text-gold-600 font-semibold hover:text-gold-700 mt-auto"
                                >
                                    Read Article
                                    <Icon
                                        name="arrowRight"
                                        className="w-4 h-4 ml-2"
                                    />
                                </a>
                            </div>
                        </article>
                    ))
                }
            </div>

            {
                sortedPosts.length === 0 && (
                    <div class="text-center py-12">
                        <p class="text-xl text-gray-500">
                            No posts found in this category.
                        </p>
                        <a
                            href="/blog"
                            class="text-gold-600 hover:underline mt-4 inline-block"
                        >
                            View all posts
                        </a>
                    </div>
                )
            }

            <div class="text-center mt-12">
                <a
                    href="/blog"
                    class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-dark-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"
                >
                    <Icon name="arrowLeft" className="w-4 h-4 mr-2" />
                    Back to All Articles
                </a>
            </div>
        </div>
    </section>

    <FinalCTA />

    <Footer />
</BaseLayout>
